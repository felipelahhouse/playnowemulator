<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#000000">
    <title>SNES Player</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            margin: 0;
            padding: 0;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        
        #loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #0ea5e9;
            z-index: 9999;
            padding: 20px;
        }
        
        #loading.hidden {
            display: none;
        }
        
        .spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(14, 165, 233, 0.2);
            border-top-color: #0ea5e9;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        #status {
            font-size: 14px;
            font-weight: 500;
            max-width: 280px;
            line-height: 1.5;
        }
        
        #game {
            width: 100vw;
            height: 100vh;
            position: relative;
        }
        
        /* Estilos específicos para mobile */
        @media (max-width: 768px) {
            body {
                overflow: hidden;
                position: fixed;
                width: 100%;
                height: 100%;
            }
            
            #game {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
            }
            
            #status {
                font-size: 12px;
                max-width: 240px;
            }
            
            .spinner {
                width: 50px;
                height: 50px;
            }
        }
        
        /* Previne scroll bounce em iOS */
        @supports (-webkit-touch-callout: none) {
            body {
                position: fixed;
                overflow: hidden;
            }
        }
    </style>
</head>
<body>
    <div id="loading">
        <div class="spinner"></div>
        <div id="status">Carregando jogo...</div>
    </div>
    <div id="game"></div>

    <script>
        // Obtém parâmetros da URL
        const params = new URLSearchParams(window.location.search);
        const romUrl = params.get('rom');
        const gameTitle = params.get('title') || 'SNES Game';
        
        // Elementos
        const loading = document.getElementById('loading');
        const status = document.getElementById('status');
        
        // Detecta dispositivo móvel
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        const isTouch = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
        
        console.log('[INFO] Device:', { isMobile, isTouch, userAgent: navigator.userAgent });
        
        // Atualiza status
        function updateStatus(text) {
            status.textContent = text;
        }
        
        // Notifica parent window
        function notifyParent(data) {
            try {
                if (window.parent && window.parent !== window) {
                    window.parent.postMessage(data, '*');
                }
            } catch (e) {
                console.warn('Could not notify parent:', e);
            }
        }
        
        if (!romUrl) {
            updateStatus('❌ Nenhuma ROM especificada');
            console.error('No ROM URL provided');
        } else {
            // Configuração do EmulatorJS - MELHORADA PARA MOBILE
            window.EJS_player = '#game';
            window.EJS_core = 'snes';
            window.EJS_gameUrl = romUrl;
            window.EJS_gameName = gameTitle;
            window.EJS_pathtodata = 'https://cdn.emulatorjs.org/stable/data/';
            
            // Configurações de compatibilidade
            window.EJS_startOnLoaded = true;
            window.EJS_biosUrl = '';
            window.EJS_videoUrl = '';
            
            // Configurações específicas para mobile
            if (isMobile || isTouch) {
                console.log('[INFO] Aplicando configurações mobile');
                window.EJS_mobile = true;
                window.EJS_VirtualGamepadSettings = {
                    enabled: true,
                    opacity: 0.7,
                    size: 1.0
                };
                // Ativa tela cheia automática em mobile
                window.EJS_defaultControls = {
                    allowFullscreen: true,
                    fullscreenOnLoad: false
                };
            }
            
            // Configurações de interface
            window.EJS_color = '#0ea5e9';
            window.EJS_backgroundColor = '#000000';
            
            // Controles
            window.EJS_gameParentUrl = window.location.href;
            window.EJS_language = 'pt-BR';
            
            // Volume padrão (mais baixo em mobile)
            window.EJS_defaultVolume = isMobile ? 0.5 : 0.7;
            
            // Melhora performance em mobile
            if (isMobile) {
                window.EJS_threads = false; // Desativa threads em mobile para compatibilidade
                window.EJS_cacheBust = true;
            }
            
            // Callbacks de estado
            window.EJS_onGameStart = function() {
                console.log('[✓] Jogo iniciado com sucesso!');
                loading.classList.add('hidden');
                notifyParent({ type: 'emulator-ready' });
                
                // Em mobile, mostra dica de controles virtuais
                if (isMobile || isTouch) {
                    console.log('[INFO] Controles virtuais ativados');
                }
            };
            
            window.EJS_ready = function() {
                console.log('[✓] Emulador pronto!');
                updateStatus('Iniciando jogo...');
            };
            
            window.EJS_onLoadState = function() {
                console.log('[✓] Estado carregado');
            };
            
            window.EJS_onSaveState = function() {
                console.log('[✓] Estado salvo');
            };
            
            // Handler de erros melhorado
            window.addEventListener('error', function(event) {
                console.error('[✗] Error:', event.error);
                if (event.error && event.error.message) {
                    const errorMsg = event.error.message;
                    updateStatus('❌ Erro: ' + errorMsg);
                    notifyParent({ 
                        type: 'emulator-error', 
                        message: errorMsg 
                    });
                }
            });
            
            // Previne zoom em mobile ao tocar rapidamente
            if (isMobile || isTouch) {
                document.addEventListener('touchstart', function(event) {
                    if (event.touches.length > 1) {
                        event.preventDefault();
                    }
                }, { passive: false });
                
                let lastTouchEnd = 0;
                document.addEventListener('touchend', function(event) {
                    const now = Date.now();
                    if (now - lastTouchEnd <= 300) {
                        event.preventDefault();
                    }
                    lastTouchEnd = now;
                }, false);
            }
            
            // Carrega o EmulatorJS
            updateStatus(isMobile ? 'Carregando emulador mobile...' : 'Baixando emulador...');
            const script = document.createElement('script');
            script.src = 'https://cdn.emulatorjs.org/stable/data/loader.js';
            script.crossOrigin = 'anonymous';
            
            script.onload = function() {
                console.log('[✓] EmulatorJS carregado');
                updateStatus('Preparando jogo...');
            };
            
            script.onerror = function(e) {
                console.error('[✗] Falha ao carregar EmulatorJS:', e);
                updateStatus('❌ Não foi possível carregar o emulador');
                notifyParent({ 
                    type: 'emulator-error', 
                    message: 'Falha ao carregar o emulador. Verifique sua conexão com a internet.' 
                });
            };
            
            document.body.appendChild(script);
            
            // Timeout progressivo
            setTimeout(() => {
                if (!loading.classList.contains('hidden')) {
                    console.warn('[!] Ainda carregando após 10s');
                    updateStatus('⏱️ Carregando... pode levar até 1 minuto na primeira vez');
                }
            }, 10000);
            
            setTimeout(() => {
                if (!loading.classList.contains('hidden')) {
                    console.warn('[!] Ainda carregando após 30s');
                    updateStatus('⏱️ Quase lá... o jogo pode ser grande');
                }
            }, 30000);
            
            // Timeout final
            setTimeout(() => {
                if (!loading.classList.contains('hidden')) {
                    console.error('[✗] Timeout ao carregar jogo');
                    updateStatus('❌ Tempo esgotado. Tente recarregar a página.');
                    notifyParent({ 
                        type: 'emulator-error', 
                        message: 'Timeout ao carregar o jogo. Tente novamente.' 
                    });
                }
            }, 60000);
        }
    </script>
</body>
</html>
